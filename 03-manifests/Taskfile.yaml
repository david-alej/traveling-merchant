version: "3"

includes:
  common:
    taskfile: ./common/Taskfile.yaml
    dir: ./common
  db:
    taskfile: ./db/Taskfile.yaml
    dir: ./db
  redis:
    taskfile: ./redis/Taskfile.yaml
    dir: ./redis

tasks:
  faulty-pods:
    desc: List all faulty pods
    cmds:
      - |
        if kubectl get pods -A | grep -qE 'CrashLoopBackOff|Error'; then
          echo "ðŸš¨ Crashing pods detected!"
          kubectl get pods -A | grep -E 'CrashLoopBackOff|Error'
          exit 1
        else
          echo "âœ… All pods are healthy."
        fi

  helm-add-bitnami-repo:
    desc: "Add bitnami repository to your local helm repository"
    cmds:
      - helm repo add bitnami https://charts.bitnami.com/bitnami

  backend:apply:
    desc: "Apply kubernetes resource manifests for backend application"
    cmds:
      - "kubectl apply -f ./backend"

  backend:port-forward:
    desc: "Port forward backend service to localhost:3000"
    cmds:
      - "kubectl port-forward svc/backend 3000"

  frontend:apply:
    desc: "Apply kubernetes resource manifests for frontend application"
    cmds:
      - "kubectl apply -f ./frontend"

  apply-all:
    - task: helm-add-bitnami-repo
    - task: common:apply-namespace
    - task: db:install-postgres
    - task: db:apply-initial-db-migration-job
    - task: redis:install-redis
    - task: common:install-nginx-gateway
    - sleep 1
    - task: common:deploy-fabric
    - task: common:deploy-metallb
    - task: common:apply-metallb
    - task: common:apply-gateway-api
    - task: backend:apply
    - task: frontend:apply
